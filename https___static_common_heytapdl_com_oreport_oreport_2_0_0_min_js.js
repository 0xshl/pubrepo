!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).oReport=t()}(this,function(){"use strict";function t(e){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function e(e,t,r){return t&&n(e.prototype,t),r&&n(e,r),e}function l(){return(l=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r,n=arguments[t];for(r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e}).apply(this,arguments)}function r(t,e){var r,n=Object.keys(t);return Object.getOwnPropertySymbols&&(r=Object.getOwnPropertySymbols(t),e&&(r=r.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),n.push.apply(n,r)),n}function s(o){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?r(Object(i),!0).forEach(function(e){var t,r,n;t=o,n=i[r=e],r in t?Object.defineProperty(t,r,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[r]=n}):Object.getOwnPropertyDescriptors?Object.defineProperties(o,Object.getOwnPropertyDescriptors(i)):r(Object(i)).forEach(function(e){Object.defineProperty(o,e,Object.getOwnPropertyDescriptor(i,e))})}return o}function a(e,t){return(a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function u(e,t,r){return(u=function(){if("undefined"!=typeof Reflect&&Reflect.construct&&!Reflect.construct.sham){if("function"==typeof Proxy)return 1;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),1}catch(e){return}}}()?Reflect.construct:function(e,t,r){var n=[null];n.push.apply(n,t);var o=new(Function.bind.apply(e,n));return r&&a(o,r.prototype),o}).apply(null,arguments)}function o(e){return function(e){if(Array.isArray(e))return c(e)}(e)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||function(e,t){if(!e)return;if("string"==typeof e)return c(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return c(e,t)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function c(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var f={defaultOptions:{id:0,appKey:"",uin:0,region:"",url:"https://jscatch.heytapmobi.com/badjs",ext:null,level:4,ignore:[],random:1,delay:1e3,repeat:5,maxLength:400,submit:null,offlineLog:!1,offlineLogExp:3,offlineLogAuto:!1,onReport:function(){},beforeReport:function(){return!0},isReplay:!1,desensitize:!0,onRecordConfirm:function(){return!1},recordUrl:"https://jscatch.heytapmobi.com/record",recordType:1,console:!1,apiSilent:!1,apiIgnore:[],apiErrorRule:[],apiHelper:{rule:/\/([a-z\-_]+)?\d{2,20}/g,target:"/$1**"},apiBeforeReport:null,captureConsole:!0,captureConsoleLevel:["log","info","warn","debug"],consoleLimitSize:2,consoleLimitCount:30,performanceReport:!0}};function p(){i(this,p),this.showConsole=!1}var d=new(e(p,[{key:"enableConsole",value:function(){this.showConsole=!0}},{key:"disableConsole",value:function(){this.showConsole=!1}},{key:"info",value:function(){this.showConsole}}]),p);function h(e,t){return Object.prototype.toString.call(e)==="[object "+(t||"Object")+"]"}function y(e){return"object"===t(e)&&e}function g(e,t){return e.toString()===t.toString()}function v(t){try{if(t.stack){var e=t.stack.match("at https?://[^\n)]+");(e=(e=e||t.stack.match("[(][^\n)]+"))?e[0]:"")&&"("===e[0]?e=e.slice(1):e&&e.startsWith("at ")&&(e=e.slice(3));var r=(r=e.match(":(\\d+):(\\d+)"))||[0,0,0];return{msg:m(t),rowNum:r[1],colNum:r[2],target:e.replace(r[0],""),_orgMsg:t.toString()}}return t.name&&t.message&&t.description?{msg:JSON.stringify(t)}:t}catch(e){return t}}function m(e){var t=e.stack.replace(/\n/gi,"").split(/\bat\b/).slice(0,9).join("@").replace(/\?[^:]+/gi,""),r=e.toString();return t.indexOf(r)<0&&(t=r+"@"+t),t}var b={};function _(e,t,r){var n;null!=e&&(n=e[t],e[t]=r(n),e[t].__orig__=n)}var w=[];function j(){i(this,j),this.db=null}var O=new(e(j,[{key:"getStore",value:function(){return this.db.transaction("logs","readwrite").objectStore("logs")}},{key:"ready",value:function(t){var r=this;if(!window.indexedDB)return t();if(this.db)setTimeout(function(){t(null,r)},0);else{var e=window.indexedDB.open("oreport_db",1);if(!e)return t();e.onerror=function(e){return t(e),!(this.offlineLog=!1)},e.onsuccess=function(e){r.db=e.target.result,setTimeout(function(){t(null,r)},500)},e.onupgradeneeded=function(e){var t=e.target.result;t.objectStoreNames.contains("logs")||t.createObjectStore("logs",{autoIncrement:!0})}}}},{key:"insertToDB",value:function(e){this.getStore().add(e)}},{key:"addLogs",value:function(e){if(this.db)for(var t=0;t<e.length;t++)this.insertToDB(e[t])}},{key:"getLogs",value:function(u,c){var e,l,f,p,d,h,y,v;this.db&&(e=this.getStore().openCursor(),l=[],f={},p=[],d={},h=[],v=y=0,e.onsuccess=function(e){var t,r,n,o,i,s,a=e.target.result;a&&a.value?(a.value.time>=u.start&&a.value.time<=u.end&&g(a.value.id,u.id)&&g(a.value.uin,u.uin)&&(r=(t=a.value).from,n=t.level,o=t.msg,i=t.time,s=t.version,"number"!=typeof f[o]&&(p.push(o),f[o]=y++),"number"!=typeof d[r]&&(h.push(r),d[r]=v++),l.push({f:d[r],l:n,m:f[o],t:i,v:s})),a.continue()):c(null,l,p,h)},e.onerror=function(e){return c(e),!0})}},{key:"clearDB",value:function(e){var r,n;this.db&&(r=this.getStore(),e?(n=Date.now()-24*(e||2)*3600*1e3,r.openCursor().onsuccess=function(e){var t=e.target.result;t&&(t.value.time<n||!t.value.time)&&(r.delete(t.primaryKey),t.continue())}):r.clear())}},{key:"save2Offline",value:function(e,t){e=l({},{id:t.id,uin:t.uin,time:+new Date,version:t.version},e),this.db?this.insertToDB(e):(this.db||w.length||this.ready(function(e,t){e&&console.error(e),t&&w.length&&(t.addLogs(w),w=[])}),w.push(e))}}]),j);function R(e){(new Image).src=e}function E(e){if(clearTimeout(A),k.length){for(;;){if(k.join("&").length<4007)break;var t=k.pop();T.push(t)}R("".concat(e._reportUrl).concat(k.join("&"),"&count=").concat(k.length,"&_t=").concat(+new Date)),0<T.length&&(R("".concat(e._reportUrl).concat(T.join("&"),"&count=").concat(T.length,"&_t=").concat(+new Date)),T=[]),A=0,k=[]}}function S(e,t,r){var n,o=[],i=[],s=[];if(y(e))for(var a in e.level=e.level||r.level,e){var u=e[a];if(null!==(n=u)&&(h(n,"Number")||n)){if(y(u))try{u=JSON.stringify(u)}catch(e){u="[OReport] detect value stringify error: "+e.toString()}"url"!==a&&"target"!==a||(u=(u+""||"").substr(0,200)),"from"===a&&(u=(u+""||"").substr(0,350)),u=(u+""||"").substr(0,r.maxLength),s.push(a+":"+u),o.push(a+"="+encodeURIComponent(u)),i.push(a+"["+t+"]="+encodeURIComponent(u))}}return[i.join("&"),s.join(","),o.join("&")]}var k=[],A=0,T=[],x=(e(D,[{key:"processLog",value:function(e,t){var r=this.config;if(r._reportUrl){for(var n=Math.random()>=r.random,o=[];e.length;){var i=!1,s=e.shift();if((!r.beforeReport||!1!==r.beforeReport(s))&&(s.msg=(s.msg+""||"").substr(0,r.maxLength),!function(e,t){if(e.type&&"badjs"===e.type){if(!y(e))return 1;var r=e.msg;return t<(b[r]=(parseInt(b[r],10)||0)+1)}}(s,r.repeat))){var a=S(s,k.length,r);if(h(r.ignore,"Array"))for(var u=0,c=r.ignore.length;u<c;u++){var l=r.ignore[u];if(h(l,"RegExp")&&l.test(a[1])||h(l,"Function")&&l(s,a[1])){i=!0;break}}i||(r.offlineLog&&O.save2Offline(s,r),n||20===s.level||(k.push(a[0]),s.errorId&&o.push(s.errorId),r.onReport&&r.onReport(r.id,s)))}}return t?E(r):!A&&k.length?A=setTimeout(E.bind(null,r),r.delay):5<=k.length&&E(r),o}}},{key:"reportOffline",value:function(e){var r,n,o,t=this.config,i=t.id,s=t.uin,a=t.url,u=navigator.userAgent,c=JSON.stringify(l(e,{userAgent:u,id:i,uin:s}));r=a+"/offlineLog",n=c,(o=document.createElement("iframe")).name="oreport_offline_"+ +new Date,o.frameborder=0,o.height=0,o.width=0,o.src="javascript:false",o.onload=function(){var e=document.createElement("form");e.style.display="none",e.target=o.name,e.method="POST",e.action=r+"/offlineLog";var t=document.createElement("input");t.style.display="none",t.type="hidden",t.name="offline_log",t.value=n,o.contentDocument.body.appendChild(e),e.appendChild(t),e.submit(),d.info("report offline log success"),setTimeout(function(){document.body.removeChild(o),o=null},5e3),o.onload=null},document.body.appendChild(o)}}]),D);function D(e){i(this,D),this.config=e}function L(u,c){return c=c||{},new Promise(function(e,t){function r(){return{ok:2==(o.status/100|0),statusText:o.statusText,status:o.status,url:o.responseURL,text:function(){return Promise.resolve(o.responseText)},json:function(){return Promise.resolve(JSON.parse(o.responseText))},blob:function(){return Promise.resolve(new Blob([o.response]))},clone:r,headers:{keys:function(){return i},entries:function(){return s},get:function(e){return a[e.toLowerCase()]},has:function(e){return e.toLowerCase()in a}}}}var n,o=new XMLHttpRequest,i=[],s=[],a={};for(n in o.open(c.method||"get",u,!0),o.onload=function(){o.getAllResponseHeaders().replace(/^(.*?):[^\S\n]*([\s\S]*?)$/gm,function(e,t,r){i.push(t=t.toLowerCase()),s.push([t,r]),a[t]=a[t]?"".concat(a[t],",").concat(r):r}),r().ok?e(r()):r().text().then(function(e){t(new Error(e))})},o.onerror=t,o.withCredentials="include"===c.credentials,c.headers)o.setRequestHeader(n,c.headers[n]);o.send(c.body||null)})}"undefined"!=typeof console&&console.error&&setTimeout(function(){var e=function(e){for(var t=window.location.search.substring(1).split("&"),r=0;r<t.length;r++){var n=t[r].split("=");if(n[0]===e)return n[1]}return!1}("BJ_ERROR");e&&console.error("BJ_ERROR",decodeURIComponent(e).replace(/(:\d+:\d+)\s*/g,"$1\n"))},0);var C=/^\s*at .*(\S+\:\d+|\(native\))/m;function N(e){return e&&e.stack&&e.stack.split?e.stack.split("\n").filter(function(e){return!!e.match(C)},this).map(function(e){-1<e.indexOf("(eval ")&&(e=e.replace(/eval code/g,"eval").replace(/(\(eval at [^\()]*)|(\)\,.*$)/g,""));var t=e.replace(/^\s+/,"").replace(/\(eval code/g,"(").split(/\s+/).slice(1),r=function(e){if(-1===e.indexOf(":"))return[e];var t=/(.+?)(?:\:(\d+))?(?:\:(\d+))?$/.exec(e.replace(/[\(\)]/g,""));return[t[1],t[2]||void 0,t[3]||void 0]}(t.pop());return{functionName:t.join(" ")||void 0,fileName:-1<["eval","<anonymous>"].indexOf(r[0])?void 0:r[0],lineNumber:r[1],columnNumber:r[2],source:e}},this):{}}var B="0123456789",I="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",P="~!@#$%^*()_+-=[]{}|;:,./<>?";function U(e,t){e=e||8;var r="",n="";for(!0===(t=t||{})?r=B+I+P:"string"==typeof t?r=t:(!1!==t.numbers&&(r+="string"==typeof t.numbers?t.numbers:B),!1!==t.letters&&(r+="string"==typeof t.letters?t.letters:I),t.specials&&(r+="string"==typeof t.specials?t.specials:P));0<e;)e--,n+=r[Math.floor(Math.random()*r.length)];return n}function F(){i(this,F),this.listeners=Object.create(null)}var H=new(e(F,[{key:"on",value:function(e,t){this.listeners[e]?this.listeners[e].includes(t)||this.listeners[e].push(t):this.listeners[e]=[t]}},{key:"off",value:function(e,t){var r=this.listeners[e]||[];r.length&&(this.listeners[e]=t?r.filter(function(e){return e!==t}):[])}},{key:"emit",value:function(e,t){(this.listeners[e]||[]).map(function(e){e(t)})}}]),F);function q(o){function e(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];var n=u(o,t);return n.addEventListener("readystatechange",function(){n&&4===n.readyState&&(n.__isFetch__?setTimeout(function(){return function(t){var e=t.response;if("string"==typeof e)return void $(t,e);if("application/json"!==e.type&&"text/plain"!==e.type)return void $(t);try{e.text&&"function"==typeof e.text?t.response.text().then(function(e){return $(t,e)}):t.__fetch__response__.__textNoLimit__().then(function(e){return $(t,e)})}catch(e){console.error(e),$(t)}}(n)}):function(e){var t="";if("json"===e.responseType)try{t=JSON.stringify(e.response)}catch(e){console.error(e)}else"text"!==e.responseType&&""!==e.responseType||(t=e.response);$(e,t)}(n))}),n}return e.prototype=o.prototype,e}function M(i){return function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];var n=t[0],o=t[1];return this.__oppo_request={url:o,method:n&&n.toUpperCase()},i.call.apply(i,[this].concat(t))}}function J(n){return function(){this.__oppo_request.sendTime=Date.now();for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return n.call.apply(n,[this].concat(t))}}function $(e,t){H.emit("ajaxEnd",s({status:e.status,endTime:Date.now(),response:t},e.__oppo_request))}var V,K,z={searchParams:"URLSearchParams"in self,iterable:"Symbol"in self&&"iterator"in Symbol,blob:"FileReader"in self&&"Blob"in self&&function(){try{return new Blob,!0}catch(e){return!1}}(),formData:"FormData"in self,arrayBuffer:"ArrayBuffer"in self};function X(e){if("string"!=typeof e&&(e=String(e)),/[^a-z0-9\-#$%&'*+.^_`|~]/i.test(e))throw new TypeError("Invalid character in header field name");return e.toLowerCase()}function Q(e){return"string"!=typeof e&&(e=String(e)),e}function G(t){var e={next:function(){var e=t.shift();return{done:void 0===e,value:e}}};return z.iterable&&(e[Symbol.iterator]=function(){return e}),e}function W(t){this.map={},t instanceof W?t.forEach(function(e,t){this.append(t,e)},this):Array.isArray(t)?t.forEach(function(e){this.append(e[0],e[1])},this):t&&Object.getOwnPropertyNames(t).forEach(function(e){this.append(e,t[e])},this)}function Y(e){if(e.bodyUsed)return Promise.reject(new TypeError("Already read"));e.bodyUsed=!0}function Z(r){return new Promise(function(e,t){r.onload=function(){e(r.result)},r.onerror=function(){t(r.error)}})}function ee(e){var t=new FileReader,r=Z(t);return t.readAsArrayBuffer(e),r}function te(e){var t=new FileReader,r=Z(t);return t.readAsText(e),r}function re(e){if(e.slice)return e.slice(0);var t=new Uint8Array(e.byteLength);return t.set(new Uint8Array(e)),t.buffer}function ne(){return this.bodyUsed=!1,this._initBody=function(e){var t;(this._bodyInit=e)?"string"==typeof e?this._bodyText=e:z.blob&&Blob.prototype.isPrototypeOf(e)?this._bodyBlob=e:z.formData&&FormData.prototype.isPrototypeOf(e)?this._bodyFormData=e:z.searchParams&&URLSearchParams.prototype.isPrototypeOf(e)?this._bodyText=e.toString():z.arrayBuffer&&z.blob&&((t=e)&&DataView.prototype.isPrototypeOf(t))?(this._bodyArrayBuffer=re(e.buffer),this._bodyInit=new Blob([this._bodyArrayBuffer])):z.arrayBuffer&&(ArrayBuffer.prototype.isPrototypeOf(e)||K(e))?this._bodyArrayBuffer=re(e):this._bodyText=e=Object.prototype.toString.call(e):this._bodyText="",this.headers.get("content-type")||("string"==typeof e?this.headers.set("content-type","text/plain;charset=UTF-8"):this._bodyBlob&&this._bodyBlob.type?this.headers.set("content-type",this._bodyBlob.type):z.searchParams&&URLSearchParams.prototype.isPrototypeOf(e)&&this.headers.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"))},z.blob&&(this.blob=function(){var e=Y(this);if(e)return e;if(this._bodyBlob)return Promise.resolve(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(new Blob([this._bodyArrayBuffer]));if(this._bodyFormData)throw new Error("could not read FormData body as blob");return Promise.resolve(new Blob([this._bodyText]))},this.arrayBuffer=function(){return this._bodyArrayBuffer?Y(this)||Promise.resolve(this._bodyArrayBuffer):this.blob().then(ee)}),this.text=function(){var e=Y(this);if(e)return e;if(this._bodyBlob)return te(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(function(e){for(var t=new Uint8Array(e),r=new Array(t.length),n=0;n<t.length;n++)r[n]=String.fromCharCode(t[n]);return r.join("")}(this._bodyArrayBuffer));if(this._bodyFormData)throw new Error("could not read FormData body as text");return Promise.resolve(this._bodyText)},this.__textNoLimit__=function(){return te(this._bodyBlob)},z.formData&&(this.formData=function(){return this.text().then(se)}),this.json=function(){return this.text().then(JSON.parse)},this}z.arrayBuffer&&(V=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object Int16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"],K=ArrayBuffer.isView||function(e){return e&&-1<V.indexOf(Object.prototype.toString.call(e))}),W.prototype.append=function(e,t){e=X(e),t=Q(t);var r=this.map[e];this.map[e]=r?r+", "+t:t},W.prototype.delete=function(e){delete this.map[X(e)]},W.prototype.get=function(e){return e=X(e),this.has(e)?this.map[e]:null},W.prototype.has=function(e){return this.map.hasOwnProperty(X(e))},W.prototype.set=function(e,t){this.map[X(e)]=Q(t)},W.prototype.forEach=function(e,t){for(var r in this.map)this.map.hasOwnProperty(r)&&e.call(t,this.map[r],r,this)},W.prototype.keys=function(){var r=[];return this.forEach(function(e,t){r.push(t)}),G(r)},W.prototype.values=function(){var t=[];return this.forEach(function(e){t.push(e)}),G(t)},W.prototype.entries=function(){var r=[];return this.forEach(function(e,t){r.push([t,e])}),G(r)},z.iterable&&(W.prototype[Symbol.iterator]=W.prototype.entries);var oe=["DELETE","GET","HEAD","OPTIONS","POST","PUT"];function ie(e,t){var r,n,o=(t=t||{}).body;if(e instanceof ie){if(e.bodyUsed)throw new TypeError("Already read");this.url=e.url,this.credentials=e.credentials,t.headers||(this.headers=new W(e.headers)),this.method=e.method,this.mode=e.mode,this.signal=e.signal,o||null==e._bodyInit||(o=e._bodyInit,e.bodyUsed=!0)}else this.url=String(e);if(this.credentials=t.credentials||this.credentials||"same-origin",!t.headers&&this.headers||(this.headers=new W(t.headers)),this.method=(r=t.method||this.method||"GET",n=r.toUpperCase(),-1<oe.indexOf(n)?n:r),this.mode=t.mode||this.mode||null,this.signal=t.signal||this.signal,this.referrer=null,("GET"===this.method||"HEAD"===this.method)&&o)throw new TypeError("Body not allowed for GET or HEAD requests");this._initBody(o)}function se(e){var o=new FormData;return e.trim().split("&").forEach(function(e){var t,r,n;e&&(r=(t=e.split("=")).shift().replace(/\+/g," "),n=t.join("=").replace(/\+/g," "),o.append(decodeURIComponent(r),decodeURIComponent(n)))}),o}function ae(e,t){t=t||{},this.type="default",this.status=void 0===t.status?200:t.status,this.ok=200<=this.status&&this.status<300,this.statusText="statusText"in t?t.statusText:"OK",this.headers=new W(t.headers),this.url=t.url||"",this._initBody(e)}ie.prototype.clone=function(){return new ie(this,{body:this._bodyInit})},ne.call(ie.prototype),ne.call(ae.prototype),ae.prototype.clone=function(){return new ae(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new W(this.headers),url:this.url})},ae.error=function(){var e=new ae(null,{status:0,statusText:""});return e.type="error",e};var ue=[301,302,303,307,308];ae.redirect=function(e,t){if(-1===ue.indexOf(t))throw new RangeError("Invalid status code");return new ae(null,{status:t,headers:{location:e}})};var ce=self.DOMException;try{new ce}catch(e){(ce=function(e,t){this.message=e,this.name=t;var r=Error(e);this.stack=r.stack}).prototype=Object.create(Error.prototype),ce.prototype.constructor=ce}function le(o,s){return new Promise(function(n,e){var t=new ie(o,s);if(t.signal&&t.signal.aborted)return e(new ce("Aborted","AbortError"));var i=new XMLHttpRequest;function r(){i.abort()}i.__isFetch__=!0,i.onload=function(){var e,o,t={status:i.status,statusText:i.statusText,headers:(e=i.getAllResponseHeaders()||"",o=new W,e.replace(/\r?\n[\t ]+/g," ").split(/\r?\n/).forEach(function(e){var t,r=e.split(":"),n=r.shift().trim();n&&(t=r.join(":").trim(),o.append(n,t))}),o)};t.url="responseURL"in i?i.responseURL:t.headers.get("X-Request-URL");var r=new ae("response"in i?i.response:i.responseText,t);i.__fetch__response__=r,n(r)},i.onerror=function(){e(new TypeError("Network request failed"))},i.ontimeout=function(){e(new TypeError("Network request failed"))},i.onabort=function(){e(new ce("Aborted","AbortError"))},i.open(t.method,t.url,!0),"include"===t.credentials?i.withCredentials=!0:"omit"===t.credentials&&(i.withCredentials=!1),"responseType"in i&&z.blob&&(i.responseType="blob",i.__blobAutoSet__=!0),t.headers.forEach(function(e,t){i.setRequestHeader(t,e)}),t.signal&&(t.signal.addEventListener("abort",r),i.onreadystatechange=function(){4===i.readyState&&t.signal.removeEventListener("abort",r)}),i.send(void 0===t._bodyInit?null:t._bodyInit)})}le.polyfill=!0,self.fetch||(self.fetch=le,self.Headers=W,self.Request=ie,self.Response=ae);var fe=[];function pe(){for(var e=0;e<fe.length;e++){if(!1===fe[e].apply(void 0,arguments))break}}var de={init:function(){return _(XMLHttpRequest.prototype,"open",M),_(XMLHttpRequest.prototype,"send",J),_(window,"XMLHttpRequest",q),window.fetch=le,window.Headers=W,window.Request=ie,window.Response=ae,H.on("ajaxEnd",pe),this},pipe:function(e){return fe.push(e),this},clearPipe:function(){return this.pipelines=[],this}},he=Number.isInteger||function(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e},ye=(e(ve,[{key:"init",value:function(){try{if(null===window.localStorage||void 0===window.localStorage)return!1;localStorage&&!localStorage.getItem(this.key)&&this.safeSet(this.key,"[]")}catch(e){}}},{key:"insert",value:function(e){var t=this.get();t.push(e);var r=t.slice(-1*this.limit);this.safeSet(this.key,JSON.stringify(r))}},{key:"get",value:function(){var e=this.getRaw();return JSON.parse(e)}},{key:"getRaw",value:function(){try{var e=localStorage&&localStorage.getItem(this.key);return e||this.init(),e||"[]"}catch(e){}}},{key:"clear",value:function(){this.safeSet(this.key,"[]")}},{key:"safeSet",value:function(e,t){t.length>this.safeLength&&this.clear();try{localStorage&&localStorage.setItem(e,t)}catch(e){["W3CException_DOM_QUOTA_EXCEEDED_ERR","QUOTA_EXCEEDED_ERR","NS_ERROR_DOM_QUOTA_REACHED","QuotaExceededError"].includes(e.name)?this.clear():console.error(e)}}}]),ve);function ve(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:30,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:2,r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"__oppo_console_db__";if(i(this,ve),!he(e))throw new Error("console日志存储的limit字段需要是整数");this.limit=e,this.key=r,this.safeLength=1024*t*1024/2,this.init()}function ge(e,t){for(var r=t&&t.plainObjects?Object.create(null):{},n=0;n<e.length;++n)void 0!==e[n]&&(r[n]=e[n]);return r}var me=function(e,o,i){var s=e[o],a=e;o in e&&(e[o]=function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];var n=function(e,t){if(!Array.isArray(e))return"";for(var r=[],n=0;n<e.length;n++)try{var o=e[n];r.push("string"==typeof o?o:JSON.stringify(e[n]))}catch(e){r.push("[值不能JSON序列化]")}return r.join(t)}(t," ");"assert"!==o&&(i&&i({level:o,msg:n}),s&&Function.prototype.apply.call(s,a,t))})},be=Object.prototype.hasOwnProperty,_e=function(){for(var e=[],t=0;t<256;++t)e.push("%"+((t<16?"0":"")+t.toString(16)).toUpperCase());return e}(),we={arrayToObject:ge,assign:function(e,r){return Object.keys(r).reduce(function(e,t){return e[t]=r[t],e},e)},compact:function(e){for(var t=[{obj:{o:e},prop:"o"}],r=[],n=0;n<t.length;++n)for(var o=t[n],i=o.obj[o.prop],s=Object.keys(i),a=0;a<s.length;++a){var u=s[a],c=i[u];"object"==typeof c&&null!==c&&-1===r.indexOf(c)&&(t.push({obj:i,prop:u}),r.push(c))}return function(e){for(;e.length;){var t=e.pop(),r=t.obj[t.prop];if(Array.isArray(r)){for(var n=[],o=0;o<r.length;++o)void 0!==r[o]&&n.push(r[o]);t.obj[t.prop]=n}}return r}(t)},decode:function(t){try{return decodeURIComponent(t.replace(/\+/g," "))}catch(e){return t}},encode:function(e){if(0===e.length)return e;for(var t="string"==typeof e?e:String(e),r="",n=0;n<t.length;++n){var o=t.charCodeAt(n);45===o||46===o||95===o||126===o||48<=o&&o<=57||65<=o&&o<=90||97<=o&&o<=122?r+=t.charAt(n):o<128?r+=_e[o]:o<2048?r+=_e[192|o>>6]+_e[128|63&o]:o<55296||57344<=o?r+=_e[224|o>>12]+_e[128|o>>6&63]+_e[128|63&o]:(n+=1,o=65536+((1023&o)<<10|1023&t.charCodeAt(n)),r+=_e[240|o>>18]+_e[128|o>>12&63]+_e[128|o>>6&63]+_e[128|63&o])}return r},isBuffer:function(e){return null!=e&&!!(e.constructor&&e.constructor.isBuffer&&e.constructor.isBuffer(e))},isRegExp:function(e){return"[object RegExp]"===Object.prototype.toString.call(e)},merge:function n(r,o,i){if(!o)return r;if("object"!=typeof o){if(Array.isArray(r))r.push(o);else{if("object"!=typeof r)return[r,o];!i.plainObjects&&!i.allowPrototypes&&be.call(Object.prototype,o)||(r[o]=!0)}return r}if("object"!=typeof r)return[r].concat(o);var e=r;return Array.isArray(r)&&!Array.isArray(o)&&(e=ge(r,i)),Array.isArray(r)&&Array.isArray(o)?(o.forEach(function(e,t){be.call(r,t)?r[t]&&"object"==typeof r[t]?r[t]=n(r[t],e,i):r.push(e):r[t]=e}),r):Object.keys(o).reduce(function(e,t){var r=o[t];return be.call(e,t)?e[t]=n(e[t],r,i):e[t]=r,e},e)}},je=String.prototype.replace,Oe=/%20/g,Re={default:"RFC3986",formatters:{RFC1738:function(e){return je.call(e,Oe,"+")},RFC3986:function(e){return e}},RFC1738:"RFC1738",RFC3986:"RFC3986"},Ee={brackets:function(e){return e+"[]"},indices:function(e,t){return e+"["+t+"]"},repeat:function(e){return e}},Se=Date.prototype.toISOString,ke={delimiter:"&",encode:!0,encoder:we.encode,encodeValuesOnly:!1,serializeDate:function(e){return Se.call(e)},skipNulls:!1,strictNullHandling:!1},Ae=(Object.prototype.hasOwnProperty,function(e,t){var r=e,n=t?we.assign({},t):{};if(null!==n.encoder&&void 0!==n.encoder&&"function"!=typeof n.encoder)throw new TypeError("Encoder has to be a function.");var o=void 0===n.delimiter?ke.delimiter:n.delimiter,i="boolean"==typeof n.strictNullHandling?n.strictNullHandling:ke.strictNullHandling,s="boolean"==typeof n.skipNulls?n.skipNulls:ke.skipNulls,a="boolean"==typeof n.encode?n.encode:ke.encode,u="function"==typeof n.encoder?n.encoder:ke.encoder,c="function"==typeof n.sort?n.sort:null,l=void 0!==n.allowDots&&n.allowDots,f="function"==typeof n.serializeDate?n.serializeDate:ke.serializeDate,p="boolean"==typeof n.encodeValuesOnly?n.encodeValuesOnly:ke.encodeValuesOnly;if(void 0===n.format)n.format=Re.default;else if(!Object.prototype.hasOwnProperty.call(Re.formatters,n.format))throw new TypeError("Unknown format option provided.");var d,h=Re.formatters[n.format];"function"==typeof n.filter?r=(d=n.filter)("",r):Array.isArray(n.filter)&&(m=d=n.filter);var y,v=[];if("object"!=typeof r||null===r)return"";y=n.arrayFormat in Ee?n.arrayFormat:!("indices"in n)||n.indices?"indices":"repeat";var g=Ee[y],m=m||Object.keys(r);c&&m.sort(c);for(var b=0;b<m.length;++b){var _=m[b];s&&null===r[_]||(v=v.concat(function e(t,r,n,o,i,s,a,u,c,l,f,p){var d=t;if("function"==typeof a)d=a(r,d);else if(d instanceof Date)d=l(d);else if(null===d){if(o)return s&&!p?s(r,ke.encoder):r;d=""}if("string"==typeof d||"number"==typeof d||"boolean"==typeof d||we.isBuffer(d))return s?[f(p?r:s(r,ke.encoder))+"="+f(s(d,ke.encoder))]:[f(r)+"="+f(String(d))];var h,y,v=[];if(void 0===d)return v;y=Array.isArray(a)?a:(h=Object.keys(d),u?h.sort(u):h);for(var g=0;g<y.length;++g){var m=y[g];i&&null===d[m]||(v=Array.isArray(d)?v.concat(e(d[m],n(r,m),n,o,i,s,a,u,c,l,f,p)):v.concat(e(d[m],r+(c?"."+m:"["+m+"]"),n,o,i,s,a,u,c,l,f,p)))}return v}(r[_],_,g,i,s,a?u:null,d,c,l,f,h,p)))}var w=v.join(o),j=!0===n.addQueryPrefix?"?":"";return 0<w.length?j+w:""});var Te=(e(xe,[{key:"getLogs",value:function(){return this.__db.get()}},{key:"clearLog",value:function(){this.__db.clear()}},{key:"sendLog",value:function(t,r){var n=this;this.__errorIds.push(r),this.__debounceTime=0,clearInterval(this.__debounceInterval),this.__debounceInterval=setInterval(function(){var e;n.__debounceTime++,20<n.__debounceTime&&(clearInterval(n.__debounceInterval),(e=n.getLogs()).length&&(e.forEach(function(e){var t;(t=e.errorId).push.apply(t,o(n.__errorIds))}),function(e,t,r){var n=e.url,o=e.id,i=e.appKey,s={};s.log=JSON.stringify(r),s.id=o,s.appKey=i,s.type="console",s.errorId=t;var a=Ae(s);L(n.replace(/badjs\/?$/,"")+"console",{method:"post",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:a}).then(function(e){return e}).catch(function(e){})}(t,r,e),n.clearLog(),n.__errorIds=[]))},1e3)}}]),xe);function xe(){var r=this,e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:["log","info","warn","debug"],t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:30,n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:2;if(i(this,xe),!Array.isArray(e))throw new Error('level参数应该是数组，比如["info", "log"]');var o=window.console||{};this.__db=new ye(t,n),e.forEach(function(e){me(o,e,function(e){var t=U();r.__db.insert(s(s({},e),{},{id:t,errorId:[],time:new Date}))})}),this.__debounceTime=0,this.__debounceInterval=0,this.__errorIds=[]}var De={"https://jscatch.heytapmobi.com/badjs":"https://jscatch.heytapmobi.com/eventTrack","https://jscatch-test.wanyol.com/badjs":"https://jscatch-test.wanyol.com/eventTrack"},Le=[],Ce=!1,Ne={msg:"default",target:"default",rowNum:0,colNum:0,level:0,type:"badjs",key:"default",value:0},Be=(e(Ie,[{key:"initConfig",value:function(){var e=this,t=this.options,r=parseInt(t.id,10),n=t.appKey;if(r)if(n){if(t.region&&"string"==typeof t.region)switch(t.region.toLowerCase()){case"sg":t.url="https://jscatch-sg-frontend.heytapmobile.com/badjs";break;case"in":t.url="https://jscatch-in-frontend.heytapmobile.com/badjs";break;case"cn":t.url="https://jscatch.heytapmobi.com/badjs"}if(t.url){for(var o in t._reportUrl="".concat(t.url,"?appKey=").concat(n,"&id=").concat(r,"&"),t)this[o]=t[o];setTimeout(function(){t.isReplay&&!e.record&&console.warn("[OReport] Error replay function require the record script. \n https://badjs.oppoer.me/helper/guide")})}else console.error("[OReport] Please Check the OReport Report Url.")}else console.error("[OReport] Please Check the OReport Business appKey.");else console.error("[OReport] Please Check the OReport Business ID.")}},{key:"initOnError",value:function(){var a,u;Ce||(a=this,u=window.onerror,window.onerror=function(e,t,r,n,o){var i="badjs_".concat(a.id,"_").concat(U(16));a.record&&a.record.taskStopRecord(i);var s=e;o&&o.stack&&(s=m(o)),h(s,"Event")&&(s+=s.type?"--"+s.type+"--"+(s.target?s.target.tagName+"::"+s.target.src:""):""),a._push({msg:s,target:t,rowNum:r,colNum:n,_orgMsg:e,level:4,errorId:i}),o&&console.error(o),u&&u.apply(window,arguments),a.consoleRecorder&&a.consoleRecorder.sendLog(a.options,i)},window.addEventListener("unhandledrejection",function(e){e.preventDefault();var t="badjs_".concat(a.id,"_").concat(U(16));a.record&&a.record.taskStopRecord(t);var r=e.reason;if(e&&e.reason&&"[object Object]"===Object.prototype.toString.call(e.reason))try{r=JSON.stringify(e.reason)}catch(e){console.error("[oReport] stringify error"),console.error(e)}return a._push({msg:r||"unhandledrejection",target:"unhandledrejection",rowNum:0,colNum:0,level:4,errorId:t}),a.consoleRecorder&&a.consoleRecorder.sendLog(a.options,t),!0}),Ce=!0)}},{key:"loadTimeTrack",value:function(){function r(e,t){var r=1<arguments.length&&void 0!==t?t:"badjs_load_track",n=De[u.url];if(!(!n||"number"!=typeof e||1e4<e||e<=0)&&r){var o,i=Math.floor(Date.now()/1e3),s=[{session_id:"badjs_reserve",res_val3:r,res_val1:e,timestamp:i,page_id:"badjs_reserve",current_url:window.location.pathname}],a="";try{a=JSON.stringify(s)}catch(e){}a&&(o={product_id:u.id,appKey:u.appKey,logTag:"20_2000",eventID:"20_2000_001",timestamp:i,uuid:"badjs_reserve",events:a,bjKey:"badjs_load_track"},(new Image).src="".concat(n,"?").concat(function(e){if(!e)return"";var t,r=[];for(t in e)r.push(t+"="+encodeURIComponent(e[t]));return r.join("&")}(o)))}}var u=this;window.addEventListener("load",function(){var e,t=window.performance&&window.performance.timing;t&&(e=t.loadEventStart-t.fetchStart,r(e))})}},{key:"initPerformanceReport",value:function(){var r=this;window.addEventListener("load",function(){var e,a,t;a=r,(t=window.performance&&window.performance.timing)&&((e=function(e,t,r,n){var o=2<arguments.length&&void 0!==r?r:[],i=3<arguments.length&&void 0!==n?n:1e4;if(isNaN(e)||isNaN(t)||e<=0||t<=0)return console.warn("[oReport] performance index get with exception."),!1;var s=Math.abs(e-t);s<i?a.reportStats(o[0],s):a.reportStats(o[1],s)})(t.loadEventStart,t.fetchStart,["load","badjs_load_unusual"]),e(t.responseEnd,t.fetchStart,["fpt","badjs_fpt_unusual"]),e(t.loadEventStart,t.domContentLoadedEventEnd,["badjs_res","badjs_res_unusual"]),e(t.domInteractive,t.fetchStart,["badjs_tti","badjs_tti_unusual"]))})}},{key:"initOffline",value:function(){var r=this;return this.offlineDB=O,this.offlineDB.ready(function(e,t){!e&&t&&setTimeout(function(){t.clearDB(r.offlineLogExp),setTimeout(function(){r.offlineLogAuto&&r._autoReportOffline()},5e3)},1e3)}),this}},{key:"initRequestInterceptor",value:function(){var o=this;de.init().pipe(function(t){var r=t.url,e=o.apiIgnore;return!e||(h(e,"Array")||(e=[e]),!e.some(function(e){return h(e,"RegExp")&&e.test(r)||h(e,"Function")&&e(s({},t))}))}).pipe(function(t){var e=t.status,r=t.response,n=o.apiErrorRule;return 500<=e||0===e||(n&&!h(n,"Array")&&(n=[n]),h(n,"Array")&&n.length?n.some(function(e){return h(e,"RegExp")&&e.test(r)||h(e,"Function")&&e(s({},t))}):400<=e)}).pipe(function(e){e.response&&200<e.response.length&&(e.response=e.response.slice(0,200)+"...")}).pipe(function(e){var t,r=e.url,n=e.response;return h(o.apiBeforeReport,"Function")&&(t=o.apiBeforeReport({url:r,response:n}),e.msg=t.msg,e.response=t.response),!0}).pipe(function(e){var t=o.apiHelper,r=t.rule,n=t.target;try{e.url=e.url.replace(r,n)}catch(e){console.error(e)}return!0}).pipe(function(e){var t=e.endTime-e.sendTime;o._push(s({type:"apiError",key:5e3<t?"badjs_apierror_unusual":"badjs_apierror"},e))})}},{key:"_processLog",value:function(e){var t,r=this,n=0<arguments.length&&void 0!==e&&e;Le.length&&((t=this.log.processLog(Le,n))&&0<t.length&&t.forEach(function(e){r.record&&r.record.recordDB.updateReport(e)}),t&&0<t.length&&setTimeout(function(){r.record&&r.record.userConfirmReportHandle(t,Le)},0),Le=[])}},{key:"_push",value:function(e,t){var r={},r=y(e)&&e instanceof Error?l({},Ne,v(e)):y(e)?l({},Ne,{msg:"default",target:"default",rowNum:0,colNum:0},e):l({},Ne,{msg:e,target:e,rowNum:0,colNum:0});return this.ext&&!r.ext&&(r.ext=this.ext),r.from||(r.from=location.href),Le.push(r),this._processLog(t),this}},{key:"report",value:function(e,t){return e&&(y(e)?e.level=4:e={msg:e,level:4,target:e},this._push(e,t)),this}},{key:"info",value:function(e){return e&&(y(e)?e.level=2:e={msg:e,level:2,target:e},this._push(e)),this}},{key:"debug",value:function(e){return e&&(y(e)?e.level=1:e={msg:e,level:1,target:e},this._push(e)),this}},{key:"addOfflineLog",value:function(e){return e&&(y(e)?e.level=20:e={msg:e,level:20},this._push(e)),this}},{key:"reportOfflineLog",value:function(){var a;window.indexedDB?(a=this).offlineDB.ready(function(e,t){var i,s;!e&&t&&(i=new Date-24*a.offlineLogExp*3600*1e3,s=+new Date,t.getLogs({start:i,end:s,id:a.id,uin:a.uin},function(e,t,r,n){var o;e?console.error(e):(d.info("offline logs length:",t.length),o={logs:t,msgObj:r,urlObj:n,startDate:i,endDate:s},a.log.reportOffline(o))}))}):this.info("unsupport offlineLog")}},{key:"_autoReportOffline",value:function(){var t=this;d.info("Ask for report offline"),L("".concat(this.url,"/offlineAuto?id=").concat(this.id,"&uin=").concat(this.uin)).then(function(e){return e.json()}).then(function(e){0===e.code&&!0===e.auto&&t.reportOfflineLog()}).catch(function(e){})}},{key:"installVueErrorHandler",value:function(e){var l,f=this;(e=e||window.Vue)&&e.config&&(d.info("Vue error handler installed."),l=e.config.errorHandler,e.config.errorHandler=function(e,t,r){var n="badjs_".concat(f.id,"_").concat(U(16));f.record&&f.record.taskStopRecord(n);var o={};"[object Object]"===Object.prototype.toString.call(t)&&(o.componentName=function(e){if(e.$root===e)return"root instance";var t=e._isVue?e.$options.name||e.$options._componentTag:e.name;return(t?"component <"+t+">":"anonymous component")+(e._isVue&&e.$options.__file?" at "+e.$options.__file:"")}(t),o.propsData=t.$options.propsData),void 0!==r&&(o.lifecycleHook=r);var i="default Vue Error Message.",s=N(e);if(e&&e.stack)i=m(e);else if("[object Object]"===Object.prototype.toString.call(e))try{i=JSON.stringify(e)}catch(e){console.error("stringify vue errorobj error"),console.error(e)}var a=0,u=0;s&&s[0]&&(a=s[0].lineNumber,u=s[0].columnNumber);var c=v(e);f._push({msg:i,target:c.target,rowNum:a,colNum:u,errorId:n}),e&&console.error(e),"function"==typeof l&&l.call(this,e,t,r),f.consoleRecorder&&f.consoleRecorder.sendLog(f.options,n)})}},{key:"reportError",value:function(e){if(!(e&&e instanceof Error))throw new Error("param is needed to be Error Object");var t="default error msg.",r=N(e);e&&e.stack&&(t=m(e));var n=0,o=0;r&&r[0]&&(n=r[0].lineNumber,o=r[0].columnNumber);var i=v(e);this._push({msg:t,target:i.target,rowNum:n,colNum:o,level:4})}},{key:"reportStats",value:function(e,t){if(!e||void 0===t)throw new Error("reportStats params error.");t=Number(t)||0,this._push({type:"stats",key:e,value:t})}}]),Ie);function Ie(e){i(this,Ie),this.options=l({},f.defaultOptions,e),this.initConfig(),this.log=new x(this.options),this.console&&d.enableConsole(),this.offlineLog&&this.initOffline(),this.captureConsole&&(this.consoleRecorder=new Te(this.captureConsoleLevel,this.consoleLimitCount,this.consoleLimitSize)),this.initOnError(),this.record=null,this.options.performanceReport&&this.initPerformanceReport(),this.loadTimeTrack(),!0!==this.apiSilent&&this.initRequestInterceptor()}return Be.__VERTION__="2.2.6",Be});
